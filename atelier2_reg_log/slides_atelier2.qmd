---
title: "Atelier 2 ‚Äî R√©gression logistique"
format:
  revealjs:
    toc: false
include-after-body: ../utils/return-site.html
---

```{r echo=FALSE}
source("../utils/requirements.R")
library(titanic); library(dplyr); library(ggplot2); library(broom); library(pROC); library(scales)
theme_set(ggplot2::theme_minimal())
data("titanic_train")
df <- titanic_train %>%
  janitor::clean_names() %>%
  mutate(survived = factor(survived, levels=c(0,1), labels=c("No","Yes")),
         sex = factor(sex), pclass = factor(pclass), embarked=factor(embarked))
```

# Plan 

- Brise-glace ‚Äî *Pourquoi une proba et pas une droite ?*
- **Th√©orie** ‚Äî logit/odds, estimation, interpr√©tation, diagnostics de base
- üöÄ **Mission 1** ‚Äî Mod√®le logistique sur Titanic
- **√âvaluation** ‚Äî confusion, sens/spec, ROC/AUC, calibration, seuils & co√ªts
- üöÄ **Mission 2** ‚Äî ROC, AUC & choix de seuil
- **Compl√©ments** ‚Äî interactions, non-lin√©arit√©s, s√©paration, r√©gularisation (aper√ßu)
- D√©brief & pi√®ges fr√©quents

---

## Brise-glace (Survie sur le titanic)

::: {.columns}
::: {.column width="50%"}
```{r}
ggplot(df, aes(sex, fill=survived)) + geom_bar(position="fill") + labs(y="Proportion", title="Survie par sexe")
```
:::
::: {.column width="50%"}
```{r}
ggplot(df, aes(fare, y=survived)) + geom_point() + labs(y="Survie", title="Survie selon le prix")
```
:::
:::


- Discussion : Pourquoi **une probabilit√© born√©e** entre 0 et 1 ? Pourquoi pas une droite comme en r√©gression lin√©aire ?

---

## Logistique : de la probabilit√© aux log-odds

- Probabilit√© $p \in (0,1)$
- **Odds** $= \dfrac{p}{1-p}$ (rapport de chances)
- **Logit** $= \log\dfrac{p}{1-p}$ (fonction *croissante*)

$$
{\log\frac{p}{1-p}}= \beta_0 + \beta_1 x_1 + \cdots + \beta_p x_p
$$

- Interpr√©tation : $\exp(\beta_j)$ = **odds ratio** (OR) pour $x_j$ (+1 unit√© ou changement de niveau).

---

## Estimation & sortie R

- Fonction : `glm(y ~ x, family=binomial, data=...)`
- `summary()` fournit les coefficients (log-odds)
- `broom::tidy(..., exponentiate=TRUE)` donne les **OR** et **IC**

```{r}
m <- glm(survived ~ sex + pclass + age + fare, data=df %>% tidyr::drop_na(), family=binomial())
summary(m)
broom::tidy(m, exponentiate=TRUE, conf.int=TRUE) %>%
  dplyr::mutate(across(c(estimate, conf.low, conf.high), round, 3))
```

::: {.callout-note}
**R√©flexion :**
- Que signifie un OR sup√©rieur √† 1 ? inf√©rieur √† 1 ?
- Pourquoi pr√©senter des OR plut√¥t que des coefficients bruts ?
:::

---

## üîç Diagnostics du mod√®le logistique

- **R√©sidus d√©viance** : rep√©rer des motifs ‚Üí un motif = variable manquante ou non-lin√©arit√©.  
- **QQ-plot** : points tr√®s √©cart√©s ‚Üí observations atypiques (influence forte).  
- **R√©sidus vs ajust√©s** : structure (U, pente) ‚Üí lien mal capt√© avec les log-odds.  
- **Leverage** : cas qui influencent beaucoup la pr√©diction.  
- **Distance de Cook** : barres hautes ‚Üí observations qui tirent les coefficients.


```{r}
par(mfrow=c(2,2)); plot(m); par(mfrow=c(1,1))
```


---

## üöÄ Transition ‚Äî Mission 1
**Objectifs p√©dagogiques :**  
- Construire un premier mod√®le logistique sur Titanic  
- Lire et interpr√©ter des **odds ratios**  
- Tester un **seuil simple (0.5)** et discuter ses limites  

üëâ Ouvrir `missions/M1_titanic.qmd`

---

## De la probabilit√© √† la d√©cision : **seuil**

- Pr√©dire $\hat p$ ne suffit pas ‚áí il faut un **seuil** pour d√©cider (Yes/No)
- **Seuil 0.5** : simple mais rarement optimal

```{r}
df_fit <- df %>% tidyr::drop_na()

prob <- predict(m, newdata = df_fit, type = "response")
pred <- factor(ifelse(prob >= 0.5, "Yes", "No"), levels = c("No","Yes"))

table(Truth = df_fit$survived, Pred = pred)
```

::: {.callout-note}
**R√©flexion :**  
- Que se passe-t-il si l‚Äôon prend un seuil tr√®s bas (0.1) ? Tr√®s haut (0.9) ?  
- Quels types d‚Äôerreurs (FP/FN) cela favorise-t-il ?
:::

---

## üìä Mesures de performance

- **Accuracy (exactitude)**  
  = proportion de pr√©dictions correctes (**(TP + TN) / Total**)  
  ‚Üí Globalement utile, mais **trompeuse si les classes sont d√©s√©quilibr√©es**.  

- **Sensibilit√© (Recall / TPR)**  
  = proportion de positifs bien d√©tect√©s (**TP / (TP + FN)**)  
  ‚Üí "Parmi les passagers qui ont surv√©cu, combien le mod√®le a-t-il bien pr√©dits ?"  

- **Sp√©cificit√© (TNR)**  
  = proportion de n√©gatifs bien d√©tect√©s (**TN / (TN + FP)**)  
  ‚Üí "Parmi ceux qui n‚Äôont pas surv√©cu, combien le mod√®le a-t-il bien class√©s ?"  

- **Pr√©cision (PPV)** *(utile si classes d√©s√©quilibr√©es)*  
  = proportion de pr√©dictions positives correctes (**TP / (TP + FP)**)  
  ‚Üí "Quand le mod√®le dit *Yes*, quelle est la confiance ?"  

- **Courbe ROC**  
  = trace la sensibilit√© (TPR) vs 1-sp√©cificit√© (FPR) pour **tous les seuils possibles**.  

- **AUC (Area Under the Curve)**  
  = probabilit√© qu‚Äôun positif ait une proba pr√©dite plus √©lev√©e qu‚Äôun n√©gatif.  
  ‚Üí 0.5 = hasard complet, 1 = discrimination parfaite.  



---

## üöÄ Transition ‚Äî Mission 2
**Objectifs p√©dagogiques :**  
- Tracer une **courbe ROC** et calculer l‚Äô**AUC**  
- Choisir un **seuil adapt√© au contexte** (co√ªts FP/FN)  
- Explorer la **calibration** du mod√®le  

üëâ Ouvrir `missions/M2_roc_seuils.qmd`

---

## ROC & AUC ‚Äî rappels utiles

- **ROC** : TPR (sensibilit√©) vs FPR (1-sp√©cificit√©)  
- **AUC** : probabilit√© qu‚Äôun positif ait un score > qu‚Äôun n√©gatif choisi au hasard  
- AUC **ne d√©pend pas** d‚Äôun seuil particulier  

---

## Choix de seuil **contextuel**

- Le choix du seuil d√©pend :  
  - **Pr√©valence** (taux de positifs)  
  - **Co√ªts** FP/FN  
- Exemples :  
  - Diagnostic m√©dical : **FN co√ªteux** ‚áí seuil bas (maximiser sensibilit√©)  
  - D√©tection fraude : **FP co√ªteux** ‚áí seuil haut (maximiser sp√©cificit√©)  

---


## Compl√©ments (aper√ßu)

- **Interactions** et **non-lin√©arit√©s** (splines, polyn√¥mes)  
- **D√©s√©quilibre des classes**  

---

## D√©brief & pi√®ges fr√©quents 

- Confondre **odds** et **probabilit√©**  
- Utiliser par d√©faut un seuil de 0.5  
- Juger un mod√®le uniquement par l‚Äô**accuracy**  
- Oublier d‚Äôint√©grer le **contexte** (co√ªts, domaine)  
